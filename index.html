<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <title>DER heatmap</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }



        input[type=range] {
            width: 100%;
        } 

      h1 {
        font-size: 20px;
        line-height: 30px;
      }

      h2 {
        font-size: 14px;
        line-height: 20px;
        margin-bottom: 10px;
      }

      a {
        text-decoration: none;
        color: #2dc4b2;
      }

      #console {
        position: absolute;
        margin: 10px;
        width: 240px;
        background-color: white;
        padding: 10px 20px;
      }

      .session {
        margin-bottom: 20px;
      }

      .row {
        height: 12px;
        width: 100%;
      }

      .colors {
        background: linear-gradient(
          to right,
          #2dc4b2,
          #3bb3c3,
          #669ec4,
          #8b88b6,
          #a2719b,
          #aa5e79
        );
        margin-bottom: 5px;
      }

      .label {
        width: 15%;
        display: inline-block;
        text-align: center;
      }
    </style>
</head>

<body>
  <div id='map'></div>
  <div id="console">
    <h1>DER Cumulative Installation Heat Map in Seattle</h1>

    <div>
      <input type="radio" id="techAll" name="tech" value="All" checked>
      <label for="techAll">All DERs</label><br>
      <input type="radio" id="techPV" name="tech" value="PV">
      <label for="techPV">Rooftop Solar</label><br>
      <input type="radio" id="techEV" name="tech" value="EV">
      <label for="techEV">Electric Vehicles</label><br>
      <input type="radio" id="techHP" name="tech" value="HP">
      <label for="techHP">Heat Pumps</label><br>
    </div>

    <p>Data:<a href="https://data.seattle.gov/Built-Environment/Electrical-Permits/c4tj-daue/about_data">Seattle Electrical Permits</a> from Seattle open data portal</p>
    <div class="session">
      <h2>Year: <label id="active-year">2019</label></h2>
      <input
        id="slider"
        class="row"
        type="range"
        min="1999"
        max="2019"
        step="1"
        value="2019"
      />
    </div>
    <p align="right"><a href="https://reconjohn.github.io/">Yohan Min</a></p>
      
  </div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmVjb25qb2huIiwiYSI6ImNtMjZ0a3EzOTBkMTAya3B2eWJzcHZ2aWgifQ.BHuInY-82Tw_XHuHXAIBIg';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [-122.293, 47.5755],
        zoom: 10,
        pitch: 30.00,
        bearing: 0
    });

    let filterYear = ['<=', ['number', ['get', 'Year']], 2019];
    let selectedTech = 'All'; // Default to 'All'


    function addHeatmapLayer(layerId, techType, color) {
    map.addLayer({
      id: layerId,
      type: 'heatmap',
      source: 'heat',
      maxzoom: 15,
      filter: ['all', ['==', ['get', 'tech'], techType], ['<=', ['number', ['get', 'Year']], selectedYear]], // Filter by tech and year
      paint: {
        'heatmap-weight': { property: 'tech', type: 'exponential', stops: [[1, 0], [62, 1]] },
        'heatmap-intensity': { stops: [[11, 0.5], [15, 2]] },
        'heatmap-color': ['interpolate', ['linear'], ['heatmap-density'], 0, 'rgba(255,255,255,0)', 0.2, color, 1, color],
        'heatmap-radius': { stops: [[11, 5], [15, 10]] },
        'heatmap-opacity': { default: 1, stops: [[14, 1], [15, 0]] }
      }
    }, 'waterway-label');
  }

  // Function to update the filters based on selected year and technology
  function updateMapFilters() {
    let yearFilter = ['<=', ['number', ['get', 'Year']], selectedYear];

    if (selectedTech === 'All') {
      // Update all layers for the selected year
      map.setFilter('PV-heat', ['all', ['==', ['get', 'tech'], 'PV'], yearFilter]);
      map.setFilter('EV-heat', ['all', ['==', ['get', 'tech'], 'EV'], yearFilter]);
      map.setFilter('HP-heat', ['all', ['==', ['get', 'tech'], 'HP'], yearFilter]);
      
      map.setLayoutProperty('PV-heat', 'visibility', 'visible');
      map.setLayoutProperty('EV-heat', 'visibility', 'visible');
      map.setLayoutProperty('HP-heat', 'visibility', 'visible');
    } else {
      // Hide all layers first
      map.setLayoutProperty('PV-heat', 'visibility', 'none');
      map.setLayoutProperty('EV-heat', 'visibility', 'none');
      map.setLayoutProperty('HP-heat', 'visibility', 'none');

      // Show only the selected technology
      if (selectedTech === 'PV') {
        map.setFilter('PV-heat', ['all', ['==', ['get', 'tech'], 'PV'], yearFilter]);
        map.setLayoutProperty('PV-heat', 'visibility', 'visible');
      } else if (selectedTech === 'EV') {
        map.setFilter('EV-heat', ['all', ['==', ['get', 'tech'], 'EV'], yearFilter]);
        map.setLayoutProperty('EV-heat', 'visibility', 'visible');
      } else if (selectedTech === 'HP') {
        map.setFilter('HP-heat', ['all', ['==', ['get', 'tech'], 'HP'], yearFilter]);
        map.setLayoutProperty('HP-heat', 'visibility', 'visible');
      }
    }
  }


    map.on('load', () => {
 
        map.addSource('heat', {
            type: 'geojson',
            data: './data/der.geojson'
        });

        addHeatmapLayer('PV-heat', 'PV', 'rgb(255,80,80)'); // Red for PV
        addHeatmapLayer('EV-heat', 'EV', 'rgb(80,80,255)'); // Blue for EV
        addHeatmapLayer('HP-heat', 'HP', 'rgb(80,255,80)'); // Green for HP

            // Initial map filter update
        updateMapFilters();

      });


        // map.addLayer(
        //     { 
        //     id: 'HP-heat',
        //     type: 'heatmap',
        //     source: 'heat',
        //     maxzoom: 15,
        //     filter: ['all', ['==', ['get', 'tech'], 'HP'], filterYear], // Filter for tech = HP
        //     paint: {
        //     // increase weight as diameter breast height increases
        //     'heatmap-weight': {
        //         property: 'tech',
        //         type: 'exponential',
        //         stops: [
        //         [1, 0],
        //         [62, 1]
        //         ]
        //     },
        //     // increase intensity as zoom level increases
        //     'heatmap-intensity': {
        //         stops: [
        //         [11, 1],
        //         [15, 3]
        //         ]
        //     },
        //     // assign color values be applied to points depending on their density
        //     'heatmap-color': [
        //         'interpolate',
        //         ['linear'],
        //         ['heatmap-density'],
        //         0,
        //         'rgba(220,255,220,0)',
        //         0.2,
        //         'rgb(160,255,160)',
        //         0.4,
        //         'rgb(120,255,120)',
        //         0.6,
        //         'rgb(80,255,80)',
        //         0.8,
        //         'rgb(40,200,40)'
        //     ],
        //     // increase radius as zoom increases
        //     'heatmap-radius': {
        //         stops: [
        //         [11, 15],
        //         [15, 20]
        //         ]
        //     },
        //     // decrease opacity to transition into the circle layer
        //     'heatmap-opacity': {
        //         default: 1,
        //         stops: [
        //         [14, 1],
        //         [15, 0]
        //         ]
        //     }
        //     }
        //     },
        //     'waterway-label'
        //     ); 


        // map.addLayer(
        //     { 
        //     id: 'PV-heat',
        //     type: 'heatmap',
        //     source: 'heat',
        //     maxzoom: 15,
        //     filter: ['all', ['==', ['get', 'tech'], 'PV'], filterYear], // Filter for tech = PV
        //     paint: {
        //     // increase weight as diameter breast height increases
        //     'heatmap-weight': {
        //         property: 'tech',
        //         type: 'exponential',
        //         stops: [
        //         [1, 0],
        //         [62, 1]
        //         ]
        //     },
        //     // increase intensity as zoom level increases
        //     'heatmap-intensity': {
        //         stops: [
        //         [11, 1],
        //         [15, 3]
        //         ]
        //     },
        //     // assign color values be applied to points depending on their density
        //     'heatmap-color': [
        //         'interpolate',
        //         ['linear'],
        //         ['heatmap-density'],

        //         0,
        //         'rgba(255,220,220,0)',
        //         0.2,
        //         'rgb(255,160,160)',
        //         0.4,
        //         'rgb(255,120,120)',
        //         0.6,
        //         'rgb(255,80,80)',
        //         0.8,
        //         'rgb(200,40,40)'
        //     ],
        //     // increase radius as zoom increases
        //     'heatmap-radius': {
        //         stops: [
        //         [11, 15],
        //         [15, 20]
        //         ]
        //     },
        //     // decrease opacity to transition into the circle layer
        //     'heatmap-opacity': {
        //         default: 1,
        //         stops: [
        //         [14, 1],
        //         [15, 0]
        //         ]
        //     }
        //     }
        //     },
        //     'waterway-label'
        //     );


        // map.addLayer(
        //     { 
        //     id: 'EV-heat',
        //     type: 'heatmap',
        //     source: 'heat',
        //     maxzoom: 15,
        //     filter: ['all', ['==', ['get', 'tech'], 'EV'], filterYear], // Filter for tech = EV
        //     paint: {
        //     // increase weight as diameter breast height increases
        //     'heatmap-weight': {
        //         property: 'tech',
        //         type: 'exponential',
        //         stops: [
        //         [1, 0],
        //         [62, 1]
        //         ]
        //     },
        //     // increase intensity as zoom level increases
        //     'heatmap-intensity': {
        //         stops: [
        //         [11, 1],
        //         [15, 3]
        //         ]
        //     },
        //     // assign color values be applied to points depending on their density
        //     'heatmap-color': [
        //         'interpolate',
        //         ['linear'],
        //         ['heatmap-density'],
        //         0,
        //         'rgba(220,220,255,0)',
        //         0.2,
        //         'rgb(160,160,255)',
        //         0.4,
        //         'rgb(120,120,255)',
        //         0.6,
        //         'rgb(80,80,255)',
        //         0.8,
        //         'rgb(40,40,200)'
        //     ],
        //     // increase radius as zoom increases
        //     'heatmap-radius': {
        //         stops: [
        //         [11, 15],
        //         [15, 20]
        //         ]
        //     },
        //     // decrease opacity to transition into the circle layer
        //     'heatmap-opacity': {
        //         default: 1,
        //         stops: [
        //         [14, 1],
        //         [15, 0]
        //         ]
        // }
        // }
        // },
        // 'waterway-label'
        // );
            
           // Update year filter when the slider is moved
  document.getElementById('yearSlider').addEventListener('input', function (e) {
    selectedYear = parseInt(e.target.value);
    document.getElementById('yearLabel').innerText = selectedYear;
    updateMapFilters(); // Update map based on new year
  });

  // Update technology filter when a new technology is selected
  document.getElementById('tech-select').addEventListener('change', function () {
    selectedTech = this.value;
    updateMapFilters(); // Update map based on new technology selection
  });

  </script>
</body>
</html>
