<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <title>DER heatmap</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }



        input[type=range] {
            width: 100%;
        } 

      h1 {
        font-size: 20px;
        line-height: 30px;
      }

      h2 {
        font-size: 14px;
        line-height: 20px;
        margin-bottom: 10px;
      }

      a {
        text-decoration: none;
        color: #2dc4b2;
      }

      #console {
        position: absolute;
        margin: 10px;
        width: 240px;
        background-color: white;
        padding: 10px 20px;
      }

      .session {
        margin-bottom: 20px;
      }

      .row {
        height: 12px;
        width: 100%;
      }

      .colors {
        background: linear-gradient(
          to right,
          #2dc4b2,
          #3bb3c3,
          #669ec4,
          #8b88b6,
          #a2719b,
          #aa5e79
        );
        margin-bottom: 5px;
      }

      .label {
        width: 15%;
        display: inline-block;
        text-align: center;
      }
    </style>
</head>

<body>
  <div id='map'></div>
  <div id="console">
    <h1>DER Cumulative Installation Heat Map in Seattle</h1>

    <div>
      <input type="radio" id="techAll" name="tech" value="All" checked>
      <label for="techAll">All DERs</label><br>
      <input type="radio" id="techPV" name="tech" value="PV">
      <label for="techPV">Rooftop Solar</label><br>
      <input type="radio" id="techEV" name="tech" value="EV">
      <label for="techEV">Electric Vehicles</label><br>
      <input type="radio" id="techHP" name="tech" value="HP">
      <label for="techHP">Heat Pumps</label><br>
    </div>

    <p>Data:<a href="https://data.seattle.gov/Built-Environment/Electrical-Permits/c4tj-daue/about_data">Seattle Electrical Permits</a> from Seattle open data portal</p>
    <div class="session">
      <h2>Year: <label id="active-year">2019</label></h2>
      <input
        id="slider"
        class="row"
        type="range"
        min="1999"
        max="2019"
        step="1"
        value="2019"
      />
    </div>
    <p align="right"><a href="https://reconjohn.github.io/">Yohan Min</a></p>
      
  </div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmVjb25qb2huIiwiYSI6ImNtMjZ0a3EzOTBkMTAya3B2eWJzcHZ2aWgifQ.BHuInY-82Tw_XHuHXAIBIg';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [-122.293, 47.5755],
        zoom: 10,
        pitch: 30.00,
        bearing: 0
    });

    let filterYear = ['<=', ['number', ['get', 'Year']], 2019];
    let selectedTech = 'All'; // Default to 'All'


  // Function to add individual heatmap layers for each technology
  function addHeatmapLayer(layerId, techType, color) {
    map.addLayer({
      id: layerId,
      type: 'heatmap',
      source: 'heat',
      maxzoom: 15,
      filter: ['==', ['get', 'tech'], techType],
      paint: {
        'heatmap-weight': {
          property: 'tech',
          type: 'exponential',
          stops: [
            [1, 0],
            [62, 1]
          ]
        },
        'heatmap-intensity': {
          stops: [
            [11, 0.5],
            [15, 1.5]
          ]
        },
        'heatmap-color': [
          'interpolate',
          ['linear'],
          ['heatmap-density'],
          0, 'rgba(255,255,255,0)',  // Transparent for low density
          0.2, color,                // Use the input color
          0.4, color,                // Use the input color
          0.6, color,                // Use the input color
          0.8, color                   // Full color for high density
        ],
        'heatmap-radius': {
          stops: [
            [11, 5],
            [15, 7]
          ]
        },
        'heatmap-opacity': {
          default: 1,
          stops: [
            [14, 1],
            [15, 0]
          ]
        }
      }
    }, 'waterway-label');
  }

  // Function to update the filters based on selected tech and year
  function updateMapFilters() {
    if (selectedTech === 'All') {
      // Show all technologies
      map.setFilter('HP-heat', ['all', ['==', ['get', 'tech'], 'HP'], filterYear]);
      map.setFilter('PV-heat', ['all', ['==', ['get', 'tech'], 'PV'], filterYear]);
      map.setFilter('EV-heat', ['all', ['==', ['get', 'tech'], 'EV'], filterYear]);
    } else {
      // Show only the selected technology
      map.setFilter('PV-heat', ['all', filterYear, ['==', ['get', 'tech'], selectedTech === 'PV' ? 'PV' : '']]);
      map.setFilter('EV-heat', ['all', filterYear, ['==', ['get', 'tech'], selectedTech === 'EV' ? 'EV' : '']]);
      map.setFilter('HP-heat', ['all', filterYear, ['==', ['get', 'tech'], selectedTech === 'HP' ? 'HP' : '']]);
    }
  }

    map.on('load', () => {
 
        map.addSource('heat', {
            type: 'geojson',
            data: './data/der.geojson'
        });

        addHeatmapLayer('HP-heat', 'HP', 'rgb(80,255,80)'); // Green for HP
        addHeatmapLayer('PV-heat', 'PV', 'rgb(255,80,80)'); // Red for PV
        addHeatmapLayer('EV-heat', 'EV', 'rgb(80,80,255)'); // Blue for EV


        map.addLayer(
            {
            'id': 'heat-point',
            'type': 'circle',
            'source': 'heat',
            'minzoom': 14,
            'filter': filterYear,
            'paint': {
            // increase the radius of the circle as the zoom level increases
            'circle-radius': {
            'property': 'Year',
            'type': 'exponential',
            'stops': [
            [{ zoom: 15, value: 1 }, 3],
            [{ zoom: 15, value: 62 }, 6],
            [{ zoom: 22, value: 1 }, 12],
            [{ zoom: 22, value: 62 }, 30]
            ]
            },
            'circle-color': {
            'property': 'Year',
            'type': 'exponential',
            'stops': [
            [0, 'rgba(236,222,239,0)'],
            [10, 'rgb(236,222,239)'],
            [20, 'rgb(208,209,230)'],
            [30, 'rgb(166,189,219)'],
            [40, 'rgb(103,169,207)'],
            [50, 'rgb(28,144,153)'],
            [60, 'rgb(1,108,89)']
            ]
            },
            'circle-stroke-color': 'white',
            'circle-stroke-width': 1,
            'circle-opacity': {
            'stops': [
            [14, 0],
            [15, 1]
            ]
            }
            }
            },
            'waterway-label'
            );

            // Update technology filter when the toggle is changed
            document.querySelectorAll('input[name="tech"]').forEach((radio) => {
            radio.addEventListener('change', (event) => {
              selectedTech = event.target.value;
              updateMapFilters();

              });
            });



          // update year filter when the slider is dragged
        document.getElementById('slider').addEventListener('input', (event) => {
          const year = parseInt(event.target.value);
          // update the map
          filterYear = ['<=', ['number', ['get', 'Year']], year];

        updateMapFilters();

        document.getElementById('active-year').innerText = year;
        });

    map.on('click', 'heat-point', (event) => {
        new mapboxgl.Popup()
        .setLngLat(event.features[0].geometry.coordinates)
        .setHTML(`<strong>tech:</strong> ${event.features[0].properties.tech}`)
        .addTo(map);
        });     
      });

  </script>
</body>
</html>
